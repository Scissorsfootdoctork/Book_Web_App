{"remainingRequest":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/babel-loader/lib/index.js!/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/kscissorfootdoctor/Desktop/Book_Web_App/src/views/store/bookSpeaking.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/src/views/store/bookSpeaking.vue","mtime":1541580605000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.array.for-each\";\nimport \"core-js/modules/es6.array.filter\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport DetailTitle from \"../../components/detail/detaiTitle\";\nimport BookInfo from \"../../components/detail/bookInfo\";\nimport Scroll from \"../../components/Scroll\";\nimport SpeakPlaying from \"../../components/speak/speakPlaying\";\nimport Bottom from \"../../components/speak/speakBottom\";\nimport SpeakWindow from \"../../components/speak/speakMask\";\nimport Toast from \"../../components/shelf/toast\";\nimport { findBook, getCategoryName } from \"../../utils/book\";\nimport { download, flatList } from \"../../api/book\";\nimport { getLocalForage } from \"../../utils/localForage\";\nimport { realPx } from \"../../utils/utils\";\nimport Epub from 'epubjs';\nglobal.ePub = Epub;\nexport default {\n  components: {\n    DetailTitle: DetailTitle,\n    BookInfo: BookInfo,\n    Scroll: Scroll,\n    SpeakPlaying: SpeakPlaying,\n    Bottom: Bottom,\n    SpeakWindow: SpeakWindow,\n    Toast: Toast\n  },\n  computed: {\n    currentMinute: function currentMinute() {\n      var m = Math.floor(this.currentPlayingTime / 60);\n      return m < 10 ? '0' + m : m;\n    },\n    currentSecond: function currentSecond() {\n      var s = Math.floor(this.currentPlayingTime - parseInt(this.currentMinute) * 60);\n      return s < 10 ? '0' + s : s;\n    },\n    totalMinute: function totalMinute() {\n      var m = Math.floor(this.totalPlayingTime / 60);\n      return m < 10 ? '0' + m : m;\n    },\n    totalSecond: function totalSecond() {\n      var s = Math.floor(this.totalPlayingTime - parseInt(this.totalMinute) * 60);\n      return s < 10 ? '0' + s : s;\n    },\n    leftMinute: function leftMinute() {\n      var m = Math.floor((this.totalPlayingTime - this.currentPlayingTime) / 60);\n      return m < 10 ? '0' + m : m;\n    },\n    leftSecond: function leftSecond() {\n      var s = Math.floor(this.totalPlayingTime - this.currentPlayingTime - parseInt(this.leftMinute) * 60);\n      return s < 10 ? '0' + s : s;\n    },\n    playInfo: function playInfo() {\n      if (this.audioCanPlay) {\n        return {\n          currentMinute: this.currentMinute,\n          currentSecond: this.currentSecond,\n          totalMinute: this.totalMinute,\n          totalSecond: this.totalSecond,\n          leftMinute: this.leftMinute,\n          leftSecond: this.leftSecond\n        };\n      } else {\n        return null;\n      }\n    },\n    lang: function lang() {\n      return this.metadata ? this.metadata.language : '';\n    },\n    disableScroll: function disableScroll() {\n      if (this.$refs.speakWindow) {\n        return this.$refs.speakWindow.visible;\n      } else {\n        return false;\n      }\n    },\n    showPlay: function showPlay() {\n      return this.playingIndex >= 0;\n    },\n    scrollBottom: function scrollBottom() {\n      return this.showPlay ? 116 : 52;\n    },\n    chapter: function chapter() {\n      return this.flatNavigation[this.playingIndex];\n    },\n    desc: function desc() {\n      if (this.description) {\n        return this.description.substring(0, 100);\n      } else {\n        return '';\n      }\n    },\n    flatNavigation: function flatNavigation() {\n      if (this.navigation) {\n        return Array.prototype.concat.apply([], Array.prototype.concat.apply([], this.doFlatNavigation(this.navigation.toc)));\n      } else {\n        return [];\n      }\n    },\n    category: function category() {\n      return this.bookItem ? getCategoryName(this.bookItem.category) : '';\n    },\n    title: function title() {\n      return this.metadata ? this.metadata.title : '';\n    },\n    author: function author() {\n      return this.metadata ? this.metadata.creator : '';\n    }\n  },\n  data: function data() {\n    return {\n      bookItem: null,\n      book: null,\n      rendition: null,\n      metadata: null,\n      cover: null,\n      navigation: null,\n      description: null,\n      ifShowContent: true,\n      playingIndex: -1,\n      paragraph: null,\n      currentSectionIndex: null,\n      currentSectionTotal: null,\n      section: null,\n      isPlaying: false,\n      audio: null,\n      audioCanPlay: false,\n      currentPlayingTime: 0,\n      totalPlayingTime: 0,\n      playStatus: 0,\n      // 0 - 未播放，1 - 播放中，2 - 暂停中\n      toastText: '',\n      isOnline: false\n    };\n  },\n  methods: {\n    onAudioEnded: function onAudioEnded() {\n      this.resetPlay();\n      this.currentPlayingTime = this.$refs.audio.currentTime;\n      var percent = Math.floor(this.currentPlayingTime / this.totalPlayingTime * 100);\n      this.$refs.speakWindow.refreshProgress(percent);\n    },\n    onTimeUpdate: function onTimeUpdate() {\n      this.currentPlayingTime = this.$refs.audio.currentTime;\n      var percent = Math.floor(this.currentPlayingTime / this.totalPlayingTime * 100);\n      this.$refs.speakWindow.refreshProgress(percent);\n    },\n    onCanPlay: function onCanPlay() {\n      this.audioCanPlay = true;\n      this.currentPlayingTime = this.$refs.audio.currentTime;\n      this.totalPlayingTime = this.$refs.audio.duration;\n    },\n    findBookFromList: function findBookFromList(fileName) {\n      var _this = this;\n\n      flatList().then(function (response) {\n        if (response.status === 200) {\n          var bookList = response.data.data.filter(function (item) {\n            return item.fileName === fileName;\n          });\n\n          if (bookList && bookList.length > 0) {\n            _this.bookItem = bookList[0];\n\n            _this.init();\n          }\n        }\n      });\n    },\n    init: function init() {\n      var _this2 = this;\n\n      var fileName = this.$route.query.fileName;\n\n      if (!this.bookItem) {\n        this.bookItem = findBook(fileName);\n      }\n\n      if (this.bookItem) {\n        getLocalForage(fileName, function (err, blob) {\n          if (err || !blob) {\n            // this.downloadBook(fileName)\n            _this2.isOnline = true;\n            var opf = _this2.$route.query.opf;\n\n            if (opf) {\n              _this2.parseBook(opf);\n            }\n          } else {\n            _this2.isOnline = false;\n\n            _this2.parseBook(blob);\n          }\n        });\n      } else {\n        this.findBookFromList(fileName);\n      }\n    },\n    downloadBook: function downloadBook(fileName) {\n      var _this3 = this;\n\n      download(this.bookItem, function () {\n        getLocalForage(fileName, function (err, blob) {\n          if (err) {\n            return;\n          }\n\n          _this3.parseBook(blob);\n        });\n      });\n    },\n    parseBook: function parseBook(blob) {\n      var _this4 = this;\n\n      this.book = new Epub(blob);\n      this.book.loaded.metadata.then(function (metadata) {\n        _this4.metadata = metadata;\n      });\n\n      if (this.isOnline) {\n        this.book.coverUrl().then(function (url) {\n          _this4.cover = url;\n        });\n      } else {\n        this.book.loaded.cover.then(function (cover) {\n          _this4.book.archive.createUrl(cover).then(function (url) {\n            _this4.cover = url;\n          });\n        });\n      }\n\n      this.book.loaded.navigation.then(function (nav) {\n        _this4.navigation = nav;\n      });\n      this.display();\n    },\n    back: function back() {\n      this.$router.go(-1);\n    },\n    onScroll: function onScroll(offsetY) {\n      if (offsetY > realPx(42)) {\n        this.$refs.title.showShadow();\n      } else {\n        this.$refs.title.hideShadow();\n      }\n    },\n    toggleContent: function toggleContent() {\n      this.ifShowContent = !this.ifShowContent;\n    },\n    display: function display() {\n      var height = window.innerHeight * 0.9 - realPx(40) - realPx(54) - realPx(46) - realPx(48) - realPx(60) - realPx(44);\n      this.rendition = this.book.renderTo('read', {\n        width: window.innerWidth,\n        height: height,\n        method: 'default'\n      });\n      this.rendition.display();\n    },\n    doFlatNavigation: function doFlatNavigation(content) {\n      var _this5 = this;\n\n      var deep = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1;\n      var arr = [];\n      content.forEach(function (item) {\n        item.deep = deep;\n        arr.push(item);\n\n        if (item.subitems && item.subitems.length > 0) {\n          arr.push(_this5.doFlatNavigation(item.subitems, deep + 1));\n        }\n      });\n      return arr;\n    },\n    speak: function speak(item, index) {\n      var _this6 = this;\n\n      this.resetPlay();\n      this.playingIndex = index;\n      this.$nextTick(function () {\n        _this6.$refs.scroll.refresh();\n      });\n\n      if (this.chapter) {\n        this.section = this.book.spine.get(this.chapter.href);\n        this.rendition.display(this.section.href).then(function (section) {\n          var currentPage = _this6.rendition.currentLocation();\n\n          var cfibase = section.cfiBase;\n          var cfistart = currentPage.start.cfi.replace(/.*!/, '').replace(/\\)/, '');\n          var cfiend = currentPage.end.cfi.replace(/.*!/, '').replace(/\\)/, '');\n          _this6.currentSectionIndex = currentPage.start.displayed.page;\n          _this6.currentSectionTotal = currentPage.start.displayed.total;\n          var cfi = \"epubcfi(\".concat(cfibase, \"!,\").concat(cfistart, \",\").concat(cfiend, \")\"); // console.log(currentPage, cfi, cfibase, cfistart, cfiend)\n\n          _this6.book.getRange(cfi).then(function (range) {\n            var text = range.toLocaleString();\n            text = text.replace(/\\s(2,)/g, '');\n            text = text.replace(/\\r/g, '');\n            text = text.replace(/\\n/g, '');\n            text = text.replace(/\\t/g, '');\n            text = text.replace(/\\f/g, '');\n\n            _this6.updateText(text);\n          });\n        });\n      }\n    },\n    showToast: function showToast(text) {\n      this.toastText = text;\n      this.$refs.toast.show();\n    },\n    togglePlay: function togglePlay() {\n      if (!this.isPlaying) {\n        if (this.playStatus === 0) {\n          this.play();\n        } else if (this.playStatus === 2) {\n          this.continuePlay();\n        }\n      } else {\n        this.pausePlay();\n      }\n    },\n    resetPlay: function resetPlay() {\n      if (this.playStatus === 1) {\n        this.pausePlay();\n      }\n\n      this.isPlaying = false;\n      this.playStatus = 0;\n    },\n    play: function play() {\n      this.createVoice(this.paragraph);\n    },\n    continuePlay: function continuePlay() {\n      var _this7 = this;\n\n      this.$refs.audio.play().then(function () {\n        _this7.$refs.speakPlaying[0].startAnimation();\n\n        _this7.isPlaying = true;\n        _this7.playStatus = 1;\n      });\n    },\n    pausePlay: function pausePlay() {\n      this.$refs.audio.pause();\n      this.$refs.speakPlaying[0].stopAnimation();\n      this.isPlaying = false;\n      this.playStatus = 2;\n    },\n    onPlayingCardClick: function onPlayingCardClick() {\n      this.$refs.speakWindow.show();\n    },\n    updateText: function updateText(text) {\n      this.paragraph = text;\n    },\n    createVoice: function createVoice(text) {\n      var xmlhttp = new XMLHttpRequest();\n      xmlhttp.open('GET', \"\".concat(process.env.VUE_APP_VOICE_URL, \"/voice?text=\").concat(text, \"&lang=\").concat(this.lang.toLowerCase()), false);\n      xmlhttp.send();\n      var xmlDoc = xmlhttp.responseText;\n\n      if (xmlDoc) {\n        var json = JSON.parse(xmlDoc);\n\n        if (json.path) {\n          this.$refs.audio.src = json.path;\n          this.continuePlay();\n        } else {\n          this.showToast('播放失败，未生成链接');\n        }\n      } else {\n        this.showToast('播放失败');\n      }\n      /*axios.create({\n        baseURL: process.env.VUE_APP_VOICE_URL + '/voice'\n      })({\n        method: 'get',\n        params: {\n          text: text,\n          lang: this.lang.toLowerCase()\n        }\n      }).then(response => {\n        if (response.status === 200) {\n          if (response.data.error === 0) {\n            const downloadUrl = response.data.path\n            console.log('开始下载...%s', downloadUrl)\n            downloadMp3(downloadUrl, blob => {\n              const url = window.URL.createObjectURL(blob)\n              console.log(blob, url)\n              this.$refs.audio.src = url\n              this.continuePlay()\n            })\n          } else {\n            this.showToast(response.data.msg)\n          }\n        } else {\n          this.showToast('请求失败')\n        }\n      }).catch(err => {\n        console.log(err)\n        this.showToast('播放失败')\n      })*/\n\n    }\n  },\n  mounted: function mounted() {\n    this.init();\n  }\n};",{"version":3,"sources":["bookSpeaking.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div class=\"book-speaking\">\n    <detail-title @back=\"back\" ref=\"title\"></detail-title>\n    <scroll class=\"content-wrapper\"\n            :top=\"42\"\n            :bottom=\"scrollBottom\"\n            :ifNoScroll=\"disableScroll\"\n            @onScroll=\"onScroll\"\n            ref=\"scroll\">\n      <book-info :cover=\"cover\"\n                 :title=\"title\"\n                 :author=\"author\"\n                 :desc=\"desc\"></book-info>\n      <div class=\"book-speak-title-wrapper\">\n        <div class=\"icon-speak-wrapper\">\n          <span class=\"icon-speak\"></span>\n        </div>\n        <div class=\"speak-title-wrapper\">\n          <span class=\"speak-title\">{{$t('speak.voice')}}</span>\n        </div>\n        <div class=\"icon-down-wrapper\" @click=\"toggleContent\">\n          <span :class=\"{'icon-down2': !ifShowContent, 'icon-up': ifShowContent}\"></span>\n        </div>\n      </div>\n      <div class=\"book-detail-content-wrapper\" v-show=\"ifShowContent\">\n        <div class=\"book-detail-content-list-wrapper\">\n          <div class=\"loading-text-wrapper\" v-if=\"!this.navigation\">\n            <span class=\"loading-text\">{{$t('detail.loading')}}</span>\n          </div>\n          <div class=\"book-detail-content-item-wrapper\">\n            <div class=\"book-detail-content-item\" v-for=\"(item, index) in flatNavigation\" :key=\"index\"\n                 @click=\"speak(item, index)\">\n              <speak-playing v-if=\"playingIndex === index\"\n                             :number=\"5\"\n                             ref=\"speakPlaying\"></speak-playing>\n              <div class=\"book-detail-content-navigation-text\" :class=\"{'is-playing': playingIndex === index}\"\n                   v-if=\"item.label\">{{item.label}}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <audio @canplay=\"onCanPlay\"\n             @timeupdate=\"onTimeUpdate\"\n             @ended=\"onAudioEnded\"\n             ref=\"audio\"></audio>\n    </scroll>\n    <bottom :chapter=\"chapter\"\n            :currentSectionIndex=\"currentSectionIndex\"\n            :currentSectionTotal=\"currentSectionTotal\"\n            :showPlay=\"showPlay\"\n            :isPlaying.sync=\"isPlaying\"\n            :playInfo=\"playInfo\"\n            @onPlayingCardClick=\"onPlayingCardClick\"></bottom>\n    <div class=\"book-wrapper\">\n      <div id=\"read\"></div>\n    </div>\n    <speak-window :title=\"this.chapter ? this.chapter.label : ''\"\n                  :book=\"book\"\n                  :section=\"section\"\n                  :currentSectionIndex.sync=\"currentSectionIndex\"\n                  :currentSectionTotal=\"currentSectionTotal\"\n                  :isPlaying.sync=\"isPlaying\"\n                  :playInfo=\"playInfo\"\n                  @updateText=\"updateText\"\n                  ref=\"speakWindow\"></speak-window>\n    <toast :text=\"toastText\" ref=\"toast\"></toast>\n  </div>\n</template>\n\n<script type=\"text/ecmascript-6\">\n  import DetailTitle from '../../components/detail/detaiTitle'\n  import BookInfo from '../../components/detail/bookInfo'\n  import Scroll from '../../components/Scroll'\n  import SpeakPlaying from '../../components/speak/speakPlaying'\n  import Bottom from '../../components/speak/speakBottom'\n  import SpeakWindow from '../../components/speak/speakMask'\n  import Toast from '../../components/shelf/toast'\n  import { findBook, getCategoryName } from '../../utils/book'\n  import { download, flatList } from '../../api/book'\n  import { getLocalForage } from '../../utils/localForage'\n  import { realPx } from '../../utils/utils'\n  import Epub from 'epubjs'\n\n  global.ePub = Epub\n\n  export default {\n    components: {\n      DetailTitle,\n      BookInfo,\n      Scroll,\n      SpeakPlaying,\n      Bottom,\n      SpeakWindow,\n      Toast\n    },\n    computed: {\n      currentMinute() {\n        const m = Math.floor(this.currentPlayingTime / 60)\n        return m < 10 ? '0' + m : m\n      },\n      currentSecond() {\n        const s = Math.floor(this.currentPlayingTime - parseInt(this.currentMinute) * 60)\n        return s < 10 ? '0' + s : s\n      },\n      totalMinute() {\n        const m = Math.floor(this.totalPlayingTime / 60)\n        return m < 10 ? '0' + m : m\n      },\n      totalSecond() {\n        const s = Math.floor(this.totalPlayingTime - parseInt(this.totalMinute) * 60)\n        return s < 10 ? '0' + s : s\n      },\n      leftMinute() {\n        const m = Math.floor((this.totalPlayingTime - this.currentPlayingTime) / 60)\n        return m < 10 ? '0' + m : m\n      },\n      leftSecond() {\n        const s = Math.floor((this.totalPlayingTime - this.currentPlayingTime) - parseInt(this.leftMinute) * 60)\n        return s < 10 ? '0' + s : s\n      },\n      playInfo() {\n        if (this.audioCanPlay) {\n          return {\n            currentMinute: this.currentMinute,\n            currentSecond: this.currentSecond,\n            totalMinute: this.totalMinute,\n            totalSecond: this.totalSecond,\n            leftMinute: this.leftMinute,\n            leftSecond: this.leftSecond\n          }\n        } else {\n          return null\n        }\n      },\n      lang() {\n        return this.metadata ? this.metadata.language : ''\n      },\n      disableScroll() {\n        if (this.$refs.speakWindow) {\n          return this.$refs.speakWindow.visible\n        } else {\n          return false\n        }\n      },\n      showPlay() {\n        return this.playingIndex >= 0\n      },\n      scrollBottom() {\n        return this.showPlay ? 116 : 52\n      },\n      chapter() {\n        return this.flatNavigation[this.playingIndex]\n      },\n      desc() {\n        if (this.description) {\n          return this.description.substring(0, 100)\n        } else {\n          return ''\n        }\n      },\n      flatNavigation() {\n        if (this.navigation) {\n          return Array.prototype.concat.apply([], Array.prototype.concat.apply([], this.doFlatNavigation(this.navigation.toc)))\n        } else {\n          return []\n        }\n      },\n      category() {\n        return this.bookItem ? getCategoryName(this.bookItem.category) : ''\n      },\n      title() {\n        return this.metadata ? this.metadata.title : ''\n      },\n      author() {\n        return this.metadata ? this.metadata.creator : ''\n      }\n    },\n    data() {\n      return {\n        bookItem: null,\n        book: null,\n        rendition: null,\n        metadata: null,\n        cover: null,\n        navigation: null,\n        description: null,\n        ifShowContent: true,\n        playingIndex: -1,\n        paragraph: null,\n        currentSectionIndex: null,\n        currentSectionTotal: null,\n        section: null,\n        isPlaying: false,\n        audio: null,\n        audioCanPlay: false,\n        currentPlayingTime: 0,\n        totalPlayingTime: 0,\n        playStatus: 0, // 0 - 未播放，1 - 播放中，2 - 暂停中\n        toastText: '',\n        isOnline: false\n      }\n    },\n    methods: {\n      onAudioEnded() {\n        this.resetPlay()\n        this.currentPlayingTime = this.$refs.audio.currentTime\n        const percent = Math.floor((this.currentPlayingTime / this.totalPlayingTime) * 100)\n        this.$refs.speakWindow.refreshProgress(percent)\n      },\n      onTimeUpdate() {\n        this.currentPlayingTime = this.$refs.audio.currentTime\n        const percent = Math.floor((this.currentPlayingTime / this.totalPlayingTime) * 100)\n        this.$refs.speakWindow.refreshProgress(percent)\n      },\n      onCanPlay() {\n        this.audioCanPlay = true\n        this.currentPlayingTime = this.$refs.audio.currentTime\n        this.totalPlayingTime = this.$refs.audio.duration\n      },\n      findBookFromList(fileName) {\n        flatList().then(response => {\n          if (response.status === 200) {\n            const bookList = response.data.data.filter(item => item.fileName === fileName)\n            if (bookList && bookList.length > 0) {\n              this.bookItem = bookList[0]\n              this.init()\n            }\n          }\n        })\n      },\n      init() {\n        const fileName = this.$route.query.fileName\n        if (!this.bookItem) {\n          this.bookItem = findBook(fileName)\n        }\n        if (this.bookItem) {\n          getLocalForage(fileName, (err, blob) => {\n            if (err || !blob) {\n              // this.downloadBook(fileName)\n              this.isOnline = true\n              const opf = this.$route.query.opf\n              if (opf) {\n                this.parseBook(opf)\n              }\n            } else {\n              this.isOnline = false\n              this.parseBook(blob)\n            }\n          })\n        } else {\n          this.findBookFromList(fileName)\n        }\n      },\n      downloadBook(fileName) {\n        download(\n          this.bookItem,\n          () => {\n            getLocalForage(fileName, (err, blob) => {\n              if (err) {\n                return\n              }\n              this.parseBook(blob)\n            })\n          })\n      },\n      parseBook(blob) {\n        this.book = new Epub(blob)\n        this.book.loaded.metadata.then(metadata => {\n          this.metadata = metadata\n        })\n        if (this.isOnline) {\n          this.book.coverUrl().then(url => {\n            this.cover = url\n          })\n        } else {\n          this.book.loaded.cover.then(cover => {\n            this.book.archive.createUrl(cover).then(url => {\n              this.cover = url\n            })\n          })\n        }\n        this.book.loaded.navigation.then(nav => {\n          this.navigation = nav\n        })\n        this.display()\n      },\n      back() {\n        this.$router.go(-1)\n      },\n      onScroll(offsetY) {\n        if (offsetY > realPx(42)) {\n          this.$refs.title.showShadow()\n        } else {\n          this.$refs.title.hideShadow()\n        }\n      },\n      toggleContent() {\n        this.ifShowContent = !this.ifShowContent\n      },\n      display() {\n        const height = window.innerHeight * 0.9 - realPx(40) - realPx(54) - realPx(46) - realPx(48) - realPx(60) - realPx(44)\n        this.rendition = this.book.renderTo('read', {\n          width: window.innerWidth,\n          height: height,\n          method: 'default'\n        })\n        this.rendition.display()\n      },\n      doFlatNavigation(content, deep = 1) {\n        const arr = []\n        content.forEach(item => {\n          item.deep = deep\n          arr.push(item)\n          if (item.subitems && item.subitems.length > 0) {\n            arr.push(this.doFlatNavigation(item.subitems, deep + 1))\n          }\n        })\n        return arr\n      },\n      speak(item, index) {\n        this.resetPlay()\n        this.playingIndex = index\n        this.$nextTick(() => {\n          this.$refs.scroll.refresh()\n        })\n        if (this.chapter) {\n          this.section = this.book.spine.get(this.chapter.href)\n          this.rendition.display(this.section.href).then(section => {\n            const currentPage = this.rendition.currentLocation()\n            const cfibase = section.cfiBase\n            const cfistart = currentPage.start.cfi.replace(/.*!/, '').replace(/\\)/, '')\n            const cfiend = currentPage.end.cfi.replace(/.*!/, '').replace(/\\)/, '')\n            this.currentSectionIndex = currentPage.start.displayed.page\n            this.currentSectionTotal = currentPage.start.displayed.total\n            const cfi = `epubcfi(${cfibase}!,${cfistart},${cfiend})`\n            // console.log(currentPage, cfi, cfibase, cfistart, cfiend)\n            this.book.getRange(cfi).then(range => {\n              let text = range.toLocaleString()\n              text = text.replace(/\\s(2,)/g, '')\n              text = text.replace(/\\r/g, '')\n              text = text.replace(/\\n/g, '')\n              text = text.replace(/\\t/g, '')\n              text = text.replace(/\\f/g, '')\n              this.updateText(text)\n            })\n          })\n        }\n      },\n      showToast(text) {\n        this.toastText = text\n        this.$refs.toast.show()\n      },\n      togglePlay() {\n        if (!this.isPlaying) {\n          if (this.playStatus === 0) {\n            this.play()\n          } else if (this.playStatus === 2) {\n            this.continuePlay()\n          }\n        } else {\n          this.pausePlay()\n        }\n      },\n      resetPlay() {\n        if (this.playStatus === 1) {\n          this.pausePlay()\n        }\n        this.isPlaying = false\n        this.playStatus = 0\n      },\n      play() {\n        this.createVoice(this.paragraph)\n      },\n      continuePlay() {\n        this.$refs.audio.play().then(() => {\n          this.$refs.speakPlaying[0].startAnimation()\n          this.isPlaying = true\n          this.playStatus = 1\n        })\n      },\n      pausePlay() {\n        this.$refs.audio.pause()\n        this.$refs.speakPlaying[0].stopAnimation()\n        this.isPlaying = false\n        this.playStatus = 2\n      },\n      onPlayingCardClick() {\n        this.$refs.speakWindow.show()\n      },\n      updateText(text) {\n        this.paragraph = text\n      },\n      createVoice(text) {\n        const xmlhttp = new XMLHttpRequest()\n        xmlhttp.open('GET', `${process.env.VUE_APP_VOICE_URL}/voice?text=${text}&lang=${this.lang.toLowerCase()}`, false)\n        xmlhttp.send()\n        const xmlDoc = xmlhttp.responseText\n        if (xmlDoc) {\n          const json = JSON.parse(xmlDoc)\n          if (json.path) {\n            this.$refs.audio.src = json.path\n            this.continuePlay()\n          } else {\n            this.showToast('播放失败，未生成链接')\n          }\n        } else {\n          this.showToast('播放失败')\n        }\n        /*axios.create({\n          baseURL: process.env.VUE_APP_VOICE_URL + '/voice'\n        })({\n          method: 'get',\n          params: {\n            text: text,\n            lang: this.lang.toLowerCase()\n          }\n        }).then(response => {\n          if (response.status === 200) {\n            if (response.data.error === 0) {\n              const downloadUrl = response.data.path\n              console.log('开始下载...%s', downloadUrl)\n              downloadMp3(downloadUrl, blob => {\n                const url = window.URL.createObjectURL(blob)\n                console.log(blob, url)\n                this.$refs.audio.src = url\n                this.continuePlay()\n              })\n            } else {\n              this.showToast(response.data.msg)\n            }\n          } else {\n            this.showToast('请求失败')\n          }\n        }).catch(err => {\n          console.log(err)\n          this.showToast('播放失败')\n        })*/\n      }\n    },\n    mounted() {\n      this.init()\n    }\n  }\n</script>\n\n<style lang=\"scss\" rel=\"stylesheet/scss\" scoped>\n  @import \"../../assets/styles/global\";\n\n  .book-speaking {\n    font-size: px2rem(16);\n    width: 100%;\n    background: white;\n    .content-wrapper {\n      width: 100%;\n      .book-speak-title-wrapper {\n        display: flex;\n        padding: px2rem(15);\n        box-sizing: border-box;\n        border-bottom: px2rem(1) solid #eee;\n        .icon-speak-wrapper {\n          flex: 0 0 px2rem(40);\n          @include left;\n          .icon-speak {\n            font-size: px2rem(24);\n            color: #999;\n          }\n        }\n        .speak-title-wrapper {\n          flex: 1;\n          @include left;\n          .speak-title {\n            font-size: px2rem(16);\n            font-weight: bold;\n            color: #666;\n          }\n        }\n        .icon-down-wrapper {\n          flex: 0 0 px2rem(40);\n          @include right;\n          .icon-up {\n            font-size: px2rem(12);\n            color: #999;\n          }\n          .icon-down2 {\n            font-size: px2rem(12);\n            color: #999;\n          }\n        }\n      }\n      .book-detail-content-wrapper {\n        width: 100%;\n        border-bottom: px2rem(1) solid #eee;\n        box-sizing: border-box;\n        .book-detail-content-list-wrapper {\n          padding: px2rem(10) px2rem(15);\n          .loading-text-wrapper {\n            width: 100%;\n            .loading-text {\n              font-size: px2rem(14);\n              color: #999;\n            }\n          }\n          .book-detail-content-item-wrapper {\n            .book-detail-content-item {\n              display: flex;\n              padding: px2rem(15) 0;\n              font-size: px2rem(14);\n              line-height: px2rem(16);\n              color: #333;\n              border-bottom: px2rem(1) solid #eee;\n              &:last-child {\n                border-bottom: none;\n              }\n              .book-detail-content-navigation-text {\n                flex: 1;\n                width: 100%;\n                @include ellipsis;\n                &.is-playing {\n                  color: $color-blue;\n                  font-weight: bold;\n                  margin-left: px2rem(10);\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n    .book-wrapper {\n      position: absolute;\n      bottom: -100%;\n      z-index: 100;\n    }\n  }\n</style>\n"],"sourceRoot":"src/views/store"}]}