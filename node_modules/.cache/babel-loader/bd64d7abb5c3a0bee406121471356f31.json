{"remainingRequest":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/babel-loader/lib/index.js!/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/kscissorfootdoctor/Desktop/Book_Web_App/src/views/store/bookDetail.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/src/views/store/bookDetail.vue","mtime":1541580605000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.string.starts-with\";\nimport \"core-js/modules/es6.regexp.replace\";\nimport \"core-js/modules/es6.regexp.constructor\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.array.for-each\";\nimport \"core-js/modules/es6.array.map\";\nimport _toConsumableArray from \"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/es6.array.filter\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport DetailTitle from '@/components/detail/detaiTitle';\nimport BookInfo from '@/components/detail/bookInfo';\nimport Scroll from '@/components/Scroll';\nimport Toast from '@/components/shelf/toast';\nimport { removeFromBookShelf, addToShelf } from '@/utils/book';\nimport { flatList, detail } from '@/api/book';\nimport { px2rem, realPx } from '@/utils/utils';\nimport { getLocalForage } from '@/utils/localForage';\nimport { getLocalStorage } from '@/utils/localStorage';\nimport Epub from 'epubjs';\nglobal.ePub = Epub;\nexport default {\n  components: {\n    DetailTitle: DetailTitle,\n    Scroll: Scroll,\n    BookInfo: BookInfo,\n    Toast: Toast\n  },\n  computed: {\n    desc: function desc() {\n      if (this.description) {\n        return this.description.substring(0, 100);\n      } else {\n        return '';\n      }\n    },\n    flatNavigation: function flatNavigation() {\n      if (this.navigation) {\n        return Array.prototype.concat.apply([], Array.prototype.concat.apply([], this.doFlatNavigation(this.navigation.toc)));\n      } else {\n        return [];\n      }\n    },\n    lang: function lang() {\n      return this.metadata ? this.metadata.language : '-';\n    },\n    isbn: function isbn() {\n      return this.metadata ? this.metadata.identifier : '-';\n    },\n    publisher: function publisher() {\n      return this.metadata ? this.metadata.publisher : '-';\n    },\n    title: function title() {\n      return this.metadata ? this.metadata.title : '';\n    },\n    author: function author() {\n      return this.metadata ? this.metadata.creator : '';\n    },\n    inBookShelf: function inBookShelf() {\n      var _this = this;\n\n      if (this.bookItem && this.bookShelf) {\n        var flatShelf = function flatten(arr) {\n          var _ref;\n\n          return (_ref = []).concat.apply(_ref, _toConsumableArray(arr.map(function (v) {\n            return v.itemList ? [v].concat(_toConsumableArray(flatten(v.itemList))) : v;\n          })));\n        }(this.bookShelf).filter(function (item) {\n          return item.type === 1;\n        });\n\n        var book = flatShelf.filter(function (item) {\n          return item.fileName === _this.bookItem.fileName;\n        });\n        return book && book.length > 0;\n      } else {\n        return false;\n      }\n    }\n  },\n  data: function data() {\n    return {\n      bookShelf: null,\n      bookItem: null,\n      book: null,\n      metadata: null,\n      trialRead: null,\n      cover: null,\n      navigation: null,\n      displayed: false,\n      audio: null,\n      randomLocation: null,\n      description: null,\n      toastText: '',\n      trialText: null,\n      categoryText: null,\n      opf: null\n    };\n  },\n  methods: {\n    addOrRemoveShelf: function addOrRemoveShelf() {\n      if (this.inBookShelf) {\n        removeFromBookShelf(this.bookItem);\n      } else {\n        addToShelf(this.bookItem);\n      }\n\n      this.bookShelf = getLocalStorage('bookShelf');\n    },\n    showToast: function showToast(text) {\n      this.toastText = text;\n      this.$refs.toast.show();\n    },\n    readBook: function readBook() {\n      var _this2 = this;\n\n      getLocalForage(this.bookItem.fileName, function (err, value) {\n        if (!err && value instanceof Blob) {\n          _this2.$router.push({\n            path: \"/ebook/\".concat(_this2.bookItem.fileName)\n          });\n        } else {\n          // this.showToast(this.$t('shelf.downloadFirst'))\n          _this2.$router.push({\n            path: \"/ebook/\".concat(_this2.bookItem.fileName),\n            query: {\n              opf: _this2.opf\n            }\n          });\n        }\n      });\n    },\n    trialListening: function trialListening() {\n      var _this3 = this;\n\n      getLocalForage(this.bookItem.fileName, function (err, value) {\n        if (!err && value instanceof Blob) {\n          _this3.$router.push({\n            path: '/book-store/book-speaking',\n            query: {\n              fileName: _this3.bookItem.fileName\n            }\n          });\n        } else {\n          // this.showToast(this.$t('shelf.downloadFirst'))\n          _this3.$router.push({\n            path: '/book-store/book-speaking',\n            query: {\n              fileName: _this3.bookItem.fileName,\n              opf: _this3.opf\n            }\n          });\n        }\n      });\n    },\n    read: function read(item) {\n      var _this4 = this;\n\n      getLocalForage(this.bookItem.fileName, function (err, value) {\n        if (!err && value instanceof Blob) {\n          _this4.$router.push({\n            path: \"/ebook/\".concat(_this4.bookItem.fileName),\n            query: {\n              navigation: item.href\n            }\n          });\n        } else {\n          // this.showToast(this.$t('shelf.downloadFirst'))\n          _this4.$router.push({\n            path: \"/ebook/\".concat(_this4.bookItem.fileName),\n            query: {\n              navigation: item.href,\n              opf: _this4.opf\n            }\n          });\n        }\n      });\n    },\n    itemStyle: function itemStyle(item) {\n      return {\n        marginLeft: (item.deep - 1) * px2rem(20) + 'rem'\n      };\n    },\n    doFlatNavigation: function doFlatNavigation(content) {\n      var _this5 = this;\n\n      var deep = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 1;\n      var arr = [];\n      content.forEach(function (item) {\n        item.deep = deep;\n        arr.push(item);\n\n        if (item.subitems && item.subitems.length > 0) {\n          arr.push(_this5.doFlatNavigation(item.subitems, deep + 1));\n        }\n      });\n      return arr;\n    },\n    initBook: function initBook() {\n      var _this6 = this;\n\n      if (this.bookItem) {\n        getLocalForage(this.bookItem.fileName, function (err, blob) {\n          if (err) {\n            _this6.downloadBook();\n          } else {\n            if (blob) {\n              _this6.parseBook(blob);\n            } else {\n              _this6.downloadBook();\n            }\n          }\n        });\n      }\n    },\n    downloadBook: function downloadBook() {\n      var opf = \"\".concat(process.env.VUE_APP_EPUB_URL, \"/\").concat(this.bookItem.categoryText, \"/\").concat(this.bookItem.fileName, \"/OEBPS/package.opf\");\n      this.parseBook(opf);\n    },\n    parseBook: function parseBook(blob) {\n      var _this7 = this;\n\n      this.book = new Epub(blob);\n      this.book.loaded.metadata.then(function (metadata) {\n        _this7.metadata = metadata;\n      });\n      this.book.loaded.navigation.then(function (nav) {\n        _this7.navigation = nav;\n\n        if (_this7.navigation.toc && _this7.navigation.toc.length > 1) {\n          _this7.display(_this7.navigation.toc[1].href).then(function (section) {\n            if (_this7.$refs.scroll) {\n              _this7.$refs.scroll.refresh();\n            }\n\n            _this7.displayed = true;\n            var reg = new RegExp('<.+?>', 'g');\n            var text = section.output.replace(reg, '').replace(/\\s\\s/g, '');\n            _this7.description = text;\n          });\n        }\n      });\n    },\n    findBookFromList: function findBookFromList(fileName) {\n      var _this8 = this;\n\n      flatList().then(function (response) {\n        if (response.status === 200) {\n          var bookList = response.data.data.filter(function (item) {\n            return item.fileName === fileName;\n          });\n\n          if (bookList && bookList.length > 0) {\n            _this8.bookItem = bookList[0];\n            console.log(_this8.bookItem);\n\n            _this8.initBook();\n          }\n        }\n      });\n    },\n    init: function init() {\n      var _this9 = this;\n\n      var fileName = this.$route.query.fileName;\n      this.categoryText = this.$route.query.category;\n\n      if (fileName) {\n        detail({\n          fileName: fileName\n        }).then(function (response) {\n          if (response.status === 200 && response.data.error_code === 0 && response.data.data) {\n            var data = response.data.data;\n            _this9.bookItem = data;\n            _this9.cover = _this9.bookItem.cover;\n            var rootFile = data.rootFile;\n\n            if (rootFile.startsWith('/')) {\n              rootFile = rootFile.substring(1, rootFile.length);\n            }\n\n            _this9.opf = \"\".concat(process.env.VUE_APP_EPUB_OPF_URL, \"/\").concat(fileName, \"/\").concat(rootFile);\n\n            _this9.parseBook(_this9.opf);\n          } else {\n            _this9.showToast(response.data.msg);\n          }\n        });\n      }\n\n      this.bookShelf = getLocalStorage('bookShelf');\n    },\n    back: function back() {\n      this.$router.go(-1);\n    },\n    display: function display(location) {\n      if (this.$refs.preview) {\n        if (!this.rendition) {\n          this.rendition = this.book.renderTo('preview', {\n            width: window.innerWidth > 640 ? 640 : window.innerWidth,\n            height: window.innerHeight,\n            method: 'default'\n          });\n        }\n\n        if (!location) {\n          return this.rendition.display();\n        } else {\n          return this.rendition.display(location);\n        }\n      }\n    },\n    onScroll: function onScroll(offsetY) {\n      if (offsetY > realPx(42)) {\n        this.$refs.title.showShadow();\n      } else {\n        this.$refs.title.hideShadow();\n      }\n    }\n  },\n  mounted: function mounted() {\n    this.init();\n  }\n};",{"version":3,"sources":["bookDetail.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div class=\"book-detail\">\n    <detail-title @back=\"back\"\n                  :showShelf=\"true\"\n                  ref=\"title\"></detail-title>\n    <scroll class=\"content-wrapper\"\n            :top=\"42\"\n            :bottom=\"52\"\n            @onScroll=\"onScroll\"\n            ref=\"scroll\">\n      <book-info :cover=\"cover\"\n                 :title=\"title\"\n                 :author=\"author\"\n                 :desc=\"desc\"></book-info>\n      <div class=\"book-detail-content-wrapper\">\n        <div class=\"book-detail-content-title\">{{$t('detail.copyright')}}</div>\n        <div class=\"book-detail-content-list-wrapper\">\n          <div class=\"book-detail-content-row\">\n            <div class=\"book-detail-content-label\">{{$t('detail.publisher')}}</div>\n            <div class=\"book-detail-content-text\">{{publisher}}</div>\n          </div>\n          <div class=\"book-detail-content-row\">\n            <div class=\"book-detail-content-label\">{{$t('detail.category')}}</div>\n            <div class=\"book-detail-content-text\">{{categoryText}}</div>\n          </div>\n          <div class=\"book-detail-content-row\">\n            <div class=\"book-detail-content-label\">{{$t('detail.lang')}}</div>\n            <div class=\"book-detail-content-text\">{{lang}}</div>\n          </div>\n          <div class=\"book-detail-content-row\">\n            <div class=\"book-detail-content-label\">{{$t('detail.ISBN')}}</div>\n            <div class=\"book-detail-content-text\">{{isbn}}</div>\n          </div>\n        </div>\n      </div>\n      <div class=\"book-detail-content-wrapper\">\n        <div class=\"book-detail-content-title\">{{$t('detail.navigation')}}</div>\n        <div class=\"book-detail-content-list-wrapper\">\n          <div class=\"loading-text-wrapper\" v-if=\"!this.navigation\">\n            <span class=\"loading-text\">{{$t('detail.loading')}}</span>\n          </div>\n          <div class=\"book-detail-content-item-wrapper\">\n            <div class=\"book-detail-content-item\" v-for=\"(item, index) in flatNavigation\" :key=\"index\"\n                 @click=\"read(item)\">\n              <div class=\"book-detail-content-navigation-text\"\n                   :class=\"{'is-sub': item.deep> 1}\"\n                   :style=\"itemStyle(item)\"\n                   v-if=\"item.label\">{{item.label}}\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class=\"book-detail-content-wrapper\">\n        <div class=\"book-detail-content-title\">{{$t('detail.trial')}}</div>\n        <div class=\"book-detail-content-list-wrapper\">\n          <div class=\"loading-text-wrapper\" v-if=\"!this.displayed\">\n            <span class=\"loading-text\">{{$t('detail.loading')}}</span>\n          </div>\n        </div>\n        <div id=\"preview\" v-show=\"this.displayed\" ref=\"preview\"></div>\n      </div>\n    </scroll>\n    <div class=\"bottom-wrapper\">\n      <div class=\"bottom-btn\" @click.stop.prevent=\"readBook()\">{{$t('detail.read')}}</div>\n      <div class=\"bottom-btn\" @click.stop.prevent=\"trialListening()\">{{$t('detail.listen')}}</div>\n      <div class=\"bottom-btn\" @click.stop.prevent=\"addOrRemoveShelf()\">\n        <span class=\"icon-check\" v-if=\"inBookShelf\"></span>\n        {{inBookShelf ? $t('detail.isAddedToShelf') : $t('detail.addOrRemoveShelf')}}\n      </div>\n    </div>\n    <toast :text=\"toastText\" ref=\"toast\"></toast>\n  </div>\n</template>\n\n<script type=\"text/ecmascript-6\">\n  import DetailTitle from '@/components/detail/detaiTitle'\n  import BookInfo from '@/components/detail/bookInfo'\n  import Scroll from '@/components/Scroll'\n  import Toast from '@/components/shelf/toast'\n  import { removeFromBookShelf, addToShelf } from '@/utils/book'\n  import { flatList, detail } from '@/api/book'\n  import { px2rem, realPx } from '@/utils/utils'\n  import { getLocalForage } from '@/utils/localForage'\n  import { getLocalStorage } from '@/utils/localStorage'\n  import Epub from 'epubjs'\n\n  global.ePub = Epub\n\n  export default {\n    components: {\n      DetailTitle,\n      Scroll,\n      BookInfo,\n      Toast\n    },\n    computed: {\n      desc() {\n        if (this.description) {\n          return this.description.substring(0, 100)\n        } else {\n          return ''\n        }\n      },\n      flatNavigation() {\n        if (this.navigation) {\n          return Array.prototype.concat.apply([], Array.prototype.concat.apply([], this.doFlatNavigation(this.navigation.toc)))\n        } else {\n          return []\n        }\n      },\n      lang() {\n        return this.metadata ? this.metadata.language : '-'\n      },\n      isbn() {\n        return this.metadata ? this.metadata.identifier : '-'\n      },\n      publisher() {\n        return this.metadata ? this.metadata.publisher : '-'\n      },\n      title() {\n        return this.metadata ? this.metadata.title : ''\n      },\n      author() {\n        return this.metadata ? this.metadata.creator : ''\n      },\n      inBookShelf() {\n        if (this.bookItem && this.bookShelf) {\n          const flatShelf = (function flatten(arr) {\n            return [].concat(...arr.map(v => v.itemList ? [v, ...flatten(v.itemList)] : v))\n          })(this.bookShelf).filter(item => item.type === 1)\n          const book = flatShelf.filter(item => item.fileName === this.bookItem.fileName)\n          return book && book.length > 0\n        } else {\n          return false\n        }\n      }\n    },\n    data() {\n      return {\n        bookShelf: null,\n        bookItem: null,\n        book: null,\n        metadata: null,\n        trialRead: null,\n        cover: null,\n        navigation: null,\n        displayed: false,\n        audio: null,\n        randomLocation: null,\n        description: null,\n        toastText: '',\n        trialText: null,\n        categoryText: null,\n        opf: null\n      }\n    },\n    methods: {\n      addOrRemoveShelf() {\n        if (this.inBookShelf) {\n          removeFromBookShelf(this.bookItem)\n        } else {\n          addToShelf(this.bookItem)\n        }\n        this.bookShelf = getLocalStorage('bookShelf')\n      },\n      showToast(text) {\n        this.toastText = text\n        this.$refs.toast.show()\n      },\n      readBook() {\n        getLocalForage(this.bookItem.fileName, (err, value) => {\n          if (!err && value instanceof Blob) {\n            this.$router.push({\n              path: `/ebook/${this.bookItem.fileName}`\n            })\n          } else {\n            // this.showToast(this.$t('shelf.downloadFirst'))\n            this.$router.push({\n              path: `/ebook/${this.bookItem.fileName}`,\n              query: {\n                opf: this.opf\n              }\n            })\n          }\n        })\n      },\n      trialListening() {\n        getLocalForage(this.bookItem.fileName, (err, value) => {\n          if (!err && value instanceof Blob) {\n            this.$router.push({\n              path: '/book-store/book-speaking',\n              query: {\n                fileName: this.bookItem.fileName\n              }\n            })\n          } else {\n            // this.showToast(this.$t('shelf.downloadFirst'))\n            this.$router.push({\n              path: '/book-store/book-speaking',\n              query: {\n                fileName: this.bookItem.fileName,\n                opf: this.opf\n              }\n            })\n          }\n        })\n      },\n      read(item) {\n        getLocalForage(this.bookItem.fileName, (err, value) => {\n          if (!err && value instanceof Blob) {\n            this.$router.push({\n              path: `/ebook/${this.bookItem.fileName}`,\n              query: {\n                navigation: item.href\n              }\n            })\n          } else {\n            // this.showToast(this.$t('shelf.downloadFirst'))\n            this.$router.push({\n              path: `/ebook/${this.bookItem.fileName}`,\n              query: {\n                navigation: item.href,\n                opf: this.opf\n              }\n            })\n          }\n        })\n      },\n      itemStyle(item) {\n        return {\n          marginLeft: (item.deep - 1) * px2rem(20) + 'rem'\n        }\n      },\n      doFlatNavigation(content, deep = 1) {\n        const arr = []\n        content.forEach(item => {\n          item.deep = deep\n          arr.push(item)\n          if (item.subitems && item.subitems.length > 0) {\n            arr.push(this.doFlatNavigation(item.subitems, deep + 1))\n          }\n        })\n        return arr\n      },\n      initBook() {\n        if (this.bookItem) {\n          getLocalForage(this.bookItem.fileName, (err, blob) => {\n            if (err) {\n              this.downloadBook()\n            } else {\n              if (blob) {\n                this.parseBook(blob)\n              } else {\n                this.downloadBook()\n              }\n            }\n          })\n        }\n      },\n      downloadBook() {\n        const opf = `${process.env.VUE_APP_EPUB_URL}/${this.bookItem.categoryText}/${this.bookItem.fileName}/OEBPS/package.opf`\n        this.parseBook(opf)\n      },\n      parseBook(blob) {\n        this.book = new Epub(blob)\n        this.book.loaded.metadata.then(metadata => {\n          this.metadata = metadata\n        })\n        this.book.loaded.navigation.then(nav => {\n          this.navigation = nav\n          if (this.navigation.toc && this.navigation.toc.length > 1) {\n            this.display(this.navigation.toc[1].href)\n              .then(section => {\n                if (this.$refs.scroll) {\n                  this.$refs.scroll.refresh()\n                }\n                this.displayed = true\n                const reg = new RegExp('<.+?>', 'g')\n                const text = section.output.replace(reg, '').replace(/\\s\\s/g, '')\n                this.description = text\n              })\n          }\n        })\n      },\n      findBookFromList(fileName) {\n        flatList().then(response => {\n          if (response.status === 200) {\n            const bookList = response.data.data.filter(item => item.fileName === fileName)\n            if (bookList && bookList.length > 0) {\n              this.bookItem = bookList[0]\n              console.log(this.bookItem)\n              this.initBook()\n            }\n          }\n        })\n      },\n      init() {\n        const fileName = this.$route.query.fileName\n        this.categoryText = this.$route.query.category\n        if (fileName) {\n          detail({\n            fileName: fileName\n          }).then(response => {\n            if (response.status === 200 && response.data.error_code === 0 && response.data.data) {\n              const data = response.data.data\n              this.bookItem = data\n              this.cover = this.bookItem.cover\n              let rootFile = data.rootFile\n              if (rootFile.startsWith('/')) {\n                rootFile = rootFile.substring(1, rootFile.length)\n              }\n              this.opf = `${process.env.VUE_APP_EPUB_OPF_URL}/${fileName}/${rootFile}`\n              this.parseBook(this.opf)\n            } else {\n              this.showToast(response.data.msg)\n            }\n          })\n        }\n        this.bookShelf = getLocalStorage('bookShelf')\n      },\n      back() {\n        this.$router.go(-1)\n      },\n      display(location) {\n        if (this.$refs.preview) {\n          if (!this.rendition) {\n            this.rendition = this.book.renderTo('preview', {\n              width: window.innerWidth > 640 ? 640 : window.innerWidth,\n              height: window.innerHeight,\n              method: 'default'\n            })\n          }\n          if (!location) {\n            return this.rendition.display()\n          } else {\n            return this.rendition.display(location)\n          }\n        }\n      },\n      onScroll(offsetY) {\n        if (offsetY > realPx(42)) {\n          this.$refs.title.showShadow()\n        } else {\n          this.$refs.title.hideShadow()\n        }\n      }\n    },\n    mounted() {\n      this.init()\n    }\n  }\n</script>\n\n<style lang=\"scss\" rel=\"stylesheet/scss\" scoped>\n  @import \"../../assets/styles/global\";\n\n  .book-detail {\n    width: 100%;\n    background: white;\n    .content-wrapper {\n      width: 100%;\n      .book-detail-content-wrapper {\n        width: 100%;\n        border-bottom: px2rem(1) solid #eee;\n        box-sizing: border-box;\n        .book-detail-content-title {\n          font-size: px2rem(20);\n          font-weight: bold;\n          padding: px2rem(20) px2rem(15) px2rem(10) px2rem(15);\n          box-sizing: border-box;\n        }\n        .book-detail-content-list-wrapper {\n          padding: px2rem(10) px2rem(15);\n          box-sizing: border-box;\n          .loading-text-wrapper {\n            width: 100%;\n            .loading-text {\n              font-size: px2rem(14);\n              color: #666;\n            }\n          }\n          .book-detail-content-row {\n            display: flex;\n            box-sizing: border-box;\n            margin-bottom: px2rem(10);\n            .book-detail-content-label {\n              flex: 0 0 px2rem(70);\n              font-size: px2rem(14);\n              color: #666;\n            }\n            .book-detail-content-text {\n              flex: 1;\n              font-size: px2rem(14);\n              color: #333;\n            }\n          }\n          #preview {\n          }\n          .book-detail-content-item-wrapper {\n            .book-detail-content-item {\n              padding: px2rem(15) 0;\n              font-size: px2rem(14);\n              line-height: px2rem(16);\n              color: #666;\n              border-bottom: px2rem(1) solid #eee;\n              &:last-child {\n                border-bottom: none;\n              }\n              .book-detail-content-navigation-text {\n                width: 100%;\n                @include ellipsis;\n                &.is-sub {\n                  color: #666;\n                }\n              }\n            }\n          }\n        }\n      }\n      .audio-wrapper {\n        width: 100%;\n        padding: px2rem(15);\n        box-sizing: border-box;\n        #audio {\n          width: 100%;\n        }\n      }\n    }\n    .bottom-wrapper {\n      position: fixed;\n      bottom: 0;\n      left: 0;\n      z-index: 120;\n      display: flex;\n      width: 100%;\n      height: px2rem(52);\n      box-shadow: 0 px2rem(-2) px2rem(2) rgba(0, 0, 0, .1);\n      .bottom-btn {\n        flex: 1;\n        color: $color-blue;\n        font-weight: bold;\n        font-size: px2rem(14);\n        @include center;\n        &:active {\n          color: $color-blue-transparent;\n        }\n        .icon-check {\n          margin-right: px2rem(5);\n        }\n      }\n      &.hide-shadow {\n        box-shadow: none;\n      }\n    }\n  }\n</style>\n"],"sourceRoot":"src/views/store"}]}