{"remainingRequest":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/babel-loader/lib/index.js!/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/kscissorfootdoctor/Desktop/Book_Web_App/src/components/ebook/EbookReader.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/src/components/ebook/EbookReader.vue","mtime":1541580605000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"core-js/modules/es6.regexp.split\";\nimport \"core-js/modules/es6.array.index-of\";\nimport \"core-js/modules/es6.regexp.match\";\nimport \"core-js/modules/es6.array.for-each\";\nimport \"core-js/modules/es6.array.filter\";\nimport \"core-js/modules/es6.array.map\";\nimport _toConsumableArray from \"/Users/kscissorfootdoctor/Desktop/Book_Web_App/node_modules/@babel/runtime-corejs2/helpers/esm/toConsumableArray\";\nimport \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.string.iterator\";\nimport \"core-js/modules/es6.function.name\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport Epub from 'epubjs';\nimport { ebookMixin } from '@/utils/mixin';\nimport { getLocalForage } from \"../../utils/localForage\";\nimport { getTheme, getFontFamily, saveFontFamily, saveTheme, getFontSize, saveFontSize, saveMetadata, getLocation } from \"../../utils/localStorage\";\nglobal.ePub = Epub;\nexport default {\n  mixins: [ebookMixin],\n  data: function data() {\n    return {\n      havePaginate: false,\n      isOnline: false\n    };\n  },\n  methods: {\n    move: function move(e) {\n      var offsetY = 0;\n\n      if (this.firstOffsetY) {\n        offsetY = e.changedTouches[0].clientY - this.firstOffsetY;\n        this.$store.commit('SET_OFFSETY', offsetY);\n      } else {\n        this.firstOffsetY = e.changedTouches[0].clientY;\n      }\n\n      e.preventDefault();\n      e.stopPropagation();\n    },\n    onMouseEnter: function onMouseEnter(e) {\n      this.mouseMove = 1;\n      this.mouseStartTime = e.timeStamp;\n      e.preventDefault();\n      e.stopPropagation();\n    },\n    onMouseMove: function onMouseMove(e) {\n      if (this.mouseMove === 1) {\n        this.mouseMove = 2;\n      } else if (this.mouseMove === 2) {\n        var offsetY = 0;\n\n        if (this.firstOffsetY) {\n          offsetY = e.clientY - this.firstOffsetY;\n          this.$store.commit('SET_OFFSETY', offsetY);\n        } else {\n          this.firstOffsetY = e.clientY;\n        }\n      }\n\n      e.preventDefault();\n      e.stopPropagation();\n    },\n    onMouseEnd: function onMouseEnd(e) {\n      if (this.mouseMove === 2) {\n        this.$store.dispatch('setOffsetY', 0);\n        this.firstOffsetY = 0;\n        this.mouseMove = 3;\n      }\n\n      this.mouseEndTime = e.timeStamp;\n      var time = this.mouseEndTime - this.mouseStartTime;\n\n      if (time < 200) {\n        this.mouseMove = 1;\n      }\n\n      e.preventDefault();\n      e.stopPropagation();\n    },\n    moveEnd: function moveEnd(e) {\n      this.$store.dispatch('setOffsetY', 0);\n      this.firstOffsetY = 0;\n    },\n    onMaskClick: function onMaskClick(e) {\n      if (this.mouseMove === 2) {} else if (this.mouseMove === 1 || this.mouseMove === 4) {\n        var offsetX = e.offsetX;\n        var width = window.innerWidth;\n\n        if (offsetX > 0 && offsetX < width * 0.3) {\n          this.prevPage();\n        } else if (offsetX > 0 && offsetX > width * 0.7) {\n          this.nextPage();\n        } else {\n          this.toggleMenuVisible();\n        }\n      }\n\n      this.mouseMove = 4;\n    },\n    prevPage: function prevPage() {\n      if (this.rendition) {\n        this.rendition.prev();\n        this.refreshLocation();\n      }\n\n      this.hideMenuVisible();\n    },\n    nextPage: function nextPage() {\n      if (this.rendition) {\n        this.rendition.next();\n        this.refreshLocation();\n      }\n\n      this.hideMenuVisible();\n    },\n    initGuest: function initGuest() {\n      var _this = this;\n\n      this.rendition.on('touchstart', function (event) {\n        _this.touchStartX = event.changedTouches[0].clientX;\n        _this.touchStartTime = event.timeStamp;\n      });\n      this.rendition.on('touchend', function (event) {\n        var offsetX = event.changedTouches[0].clientX - _this.touchStartX;\n        var time = event.timeStamp - _this.touchStartTime;\n\n        if (time < 500 && offsetX > 40) {\n          _this.prevPage();\n        } else if (time < 500 && offsetX < -40) {\n          _this.nextPage();\n        } else {\n          _this.toggleMenuVisible();\n        }\n\n        event.preventDefault();\n        event.stopPropagation();\n      });\n    },\n    initTheme: function initTheme() {\n      var defaultTheme = getTheme(this.fileName);\n\n      if (!defaultTheme) {\n        defaultTheme = this.themeList[0].name;\n        saveTheme(this.fileName, defaultTheme);\n      }\n\n      return defaultTheme;\n    },\n    initFontSize: function initFontSize() {\n      var fontSize = getFontSize(this.fileName);\n\n      if (!fontSize) {\n        fontSize = 16;\n        saveFontSize(this.fileName, fontSize);\n      }\n\n      return fontSize;\n    },\n    initFontFamily: function initFontFamily() {\n      var font = getFontFamily(this.fileName);\n\n      if (!font) {\n        font = 'Default';\n        saveFontFamily(this.fileName, font);\n      }\n\n      return font;\n    },\n    initRendition: function initRendition() {\n      var _this2 = this;\n\n      this.rendition = this.book.renderTo('read', {\n        width: window.innerWidth,\n        height: window.innerHeight,\n        method: 'default'\n      });\n      Promise.all([this.setDefaultTheme(this.initTheme()), this.setDefaultFontSize(this.initFontSize()), this.setDefaultFontFamily(this.initFontFamily())]).then(function () {\n        _this2.switchTheme();\n\n        if (_this2.$route.query.navigation) {\n          _this2.display(_this2.$route.query.navigation);\n        } else {\n          var location = getLocation(_this2.fileName);\n\n          if (location) {\n            _this2.display(location);\n          } else {\n            _this2.display();\n          }\n        }\n      });\n      this.rendition.hooks.content.register(function (contents) {\n        Promise.all([contents.addStylesheet(\"\".concat(process.env.VUE_APP_RES_URL, \"/fonts/daysOne.css\")), contents.addStylesheet(\"\".concat(process.env.VUE_APP_RES_URL, \"/fonts/tangerine.css\")), contents.addStylesheet(\"\".concat(process.env.VUE_APP_RES_URL, \"/fonts/montserrat.css\")), contents.addStylesheet(\"\".concat(process.env.VUE_APP_RES_URL, \"/fonts/cabin.css\"))]).then(function () {});\n      });\n    },\n    parseBook: function parseBook() {\n      var _this3 = this;\n\n      this.book.loaded.metadata.then(function (metadata) {\n        _this3.setMetadata(metadata);\n\n        saveMetadata(_this3.fileName, metadata);\n      });\n\n      if (this.isOnline) {\n        this.book.coverUrl().then(function (url) {\n          _this3.setCover(url);\n        });\n      } else {\n        this.book.loaded.cover.then(function (cover) {\n          _this3.book.archive.createUrl(cover).then(function (url) {\n            _this3.setCover(url);\n          });\n        });\n      }\n\n      this.book.loaded.navigation.then(function (nav) {\n        console.log(nav);\n\n        var navItem = function flatten(arr) {\n          var _ref;\n\n          return (_ref = []).concat.apply(_ref, _toConsumableArray(arr.map(function (v) {\n            return [v].concat(_toConsumableArray(flatten(v.subitems)));\n          })));\n        }(nav.toc);\n\n        function find(item) {\n          var v = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;\n          var parent = navItem.filter(function (it) {\n            return it.id === item.parent;\n          })[0];\n          return !item.parent ? v : parent ? find(parent, ++v) : v;\n        }\n\n        navItem.forEach(function (item) {\n          item.level = find(item);\n          item.total = 0;\n          item.pagelist = [];\n\n          if (item.href.match(/^(.*)\\.html$/)) {\n            item.idhref = item.href.match(/^(.*)\\.html$/)[1];\n          } else if (item.href.match(/^(.*)\\.xhtml$/)) {\n            item.idhref = item.href.match(/^(.*)\\.xhtml$/)[1];\n          }\n        });\n\n        _this3.setNavigation(navItem);\n      });\n      this.book.ready.then(function () {\n        _this3.setCurrentBook(_this3.book);\n\n        return _this3.book.locations.generate(750 * (window.innerWidth / 375) * (getFontSize(_this3.fileName) / 16));\n      }).then(function (locations) {\n        locations.forEach(function (location) {\n          var loc = location.match(/\\[(.*)\\]!/)[1];\n          console.log(loc);\n\n          _this3.navigation.forEach(function (item) {\n            if (item.idhref && item.idhref.indexOf(loc) >= 0) {\n              item.pagelist.push(location);\n            }\n          });\n\n          var currentPage = 1;\n\n          _this3.navigation.forEach(function (item, index) {\n            if (index === 0) {\n              item.page = 1;\n            } else {\n              item.page = currentPage;\n            }\n\n            currentPage += item.pagelist.length + 1;\n          });\n        }); // saveNavigation(this.fileName, this.navigation)\n\n        _this3.setPagelist(locations);\n\n        _this3.setBookAvailable(true);\n\n        _this3.setIsPaginating(false);\n\n        _this3.refreshLocation();\n      });\n    },\n    initEpub: function initEpub(target) {\n      this.book = new Epub(target);\n      this.setCurrentBook(this.book);\n      this.setIsPaginating(true);\n      this.setPaginate(this.$t('book.paginating'));\n      this.initRendition();\n      this.initGuest();\n      this.parseBook();\n    }\n  },\n  mounted: function mounted() {\n    var _this4 = this;\n\n    if (this.$route.params.fileName.indexOf('|') > 0) {\n      this.setFileName(this.$route.params.fileName.split('|').join('/')).then(function () {\n        // 实时下载电子书\n        _this4.initEpub(\"\".concat(process.env.VUE_APP_EPUB_URL, \"/\").concat(_this4.fileName, \".epub\"));\n\n        _this4.isOnline = false;\n      });\n    } else {\n      this.setFileName(this.$route.params.fileName).then(function () {\n        getLocalForage(_this4.fileName, function (err, blob) {\n          if (!err) {\n            if (blob) {\n              // 离线阅读模式\n              _this4.isOnline = false;\n\n              _this4.initEpub(blob);\n            } else {\n              // 在线阅读模式\n              _this4.isOnline = true;\n              var opf = _this4.$route.query.opf;\n\n              if (opf) {\n                _this4.initEpub(opf);\n              }\n            }\n          }\n        });\n      });\n    }\n  }\n};",{"version":3,"sources":["EbookReader.vue"],"names":[],"mappings":"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","sourcesContent":["<template>\n  <div class=\"ebook-reader\">\n    <div class=\"ebook-reader-mask\"\n         @touchmove=\"move\"\n         @touchend=\"moveEnd\"\n         @mousedown.left=\"onMouseEnter\"\n         @mousemove.left=\"onMouseMove\"\n         @mouseup.left=\"onMouseEnd\" @click=\"onMaskClick\"></div>\n    <div class=\"read-wrapper\">\n      <div id=\"read\"></div>\n    </div>\n  </div>\n</template>\n\n<script type=\"text/ecmascript-6\">\n  import Epub from 'epubjs'\n  import { ebookMixin } from '@/utils/mixin'\n  import { getLocalForage } from '../../utils/localForage'\n  import {\n    getTheme,\n    getFontFamily,\n    saveFontFamily,\n    saveTheme,\n    getFontSize,\n    saveFontSize,\n    saveMetadata,\n    getLocation\n  } from '../../utils/localStorage'\n\n  global.ePub = Epub\n  export default {\n    mixins: [ebookMixin],\n    data() {\n      return {\n        havePaginate: false,\n        isOnline: false\n      }\n    },\n    methods: {\n      move(e) {\n        let offsetY = 0\n        if (this.firstOffsetY) {\n          offsetY = e.changedTouches[0].clientY - this.firstOffsetY\n          this.$store.commit('SET_OFFSETY', offsetY)\n        } else {\n          this.firstOffsetY = e.changedTouches[0].clientY\n        }\n        e.preventDefault()\n        e.stopPropagation()\n      },\n      onMouseEnter(e) {\n        this.mouseMove = 1\n        this.mouseStartTime = e.timeStamp\n        e.preventDefault()\n        e.stopPropagation()\n      },\n      onMouseMove(e) {\n        if (this.mouseMove === 1) {\n          this.mouseMove = 2\n        } else if (this.mouseMove === 2) {\n          let offsetY = 0\n          if (this.firstOffsetY) {\n            offsetY = e.clientY - this.firstOffsetY\n            this.$store.commit('SET_OFFSETY', offsetY)\n          } else {\n            this.firstOffsetY = e.clientY\n          }\n        }\n        e.preventDefault()\n        e.stopPropagation()\n      },\n      onMouseEnd(e) {\n        if (this.mouseMove === 2) {\n          this.$store.dispatch('setOffsetY', 0)\n          this.firstOffsetY = 0\n          this.mouseMove = 3\n        }\n        this.mouseEndTime = e.timeStamp\n        const time = this.mouseEndTime - this.mouseStartTime\n        if (time < 200) {\n          this.mouseMove = 1\n        }\n        e.preventDefault()\n        e.stopPropagation()\n      },\n      moveEnd(e) {\n        this.$store.dispatch('setOffsetY', 0)\n        this.firstOffsetY = 0\n      },\n      onMaskClick(e) {\n        if (this.mouseMove === 2) {\n        } else if (this.mouseMove === 1 || this.mouseMove === 4) {\n          const offsetX = e.offsetX\n          const width = window.innerWidth\n          if (offsetX > 0 && offsetX < width * 0.3) {\n            this.prevPage()\n          } else if (offsetX > 0 && offsetX > width * 0.7) {\n            this.nextPage()\n          } else {\n            this.toggleMenuVisible()\n          }\n        }\n        this.mouseMove = 4\n      },\n      prevPage() {\n        if (this.rendition) {\n          this.rendition.prev()\n          this.refreshLocation()\n        }\n        this.hideMenuVisible()\n      },\n      nextPage() {\n        if (this.rendition) {\n          this.rendition.next()\n          this.refreshLocation()\n        }\n        this.hideMenuVisible()\n      },\n      initGuest() {\n        this.rendition.on('touchstart', event => {\n          this.touchStartX = event.changedTouches[0].clientX\n          this.touchStartTime = event.timeStamp\n        })\n        this.rendition.on('touchend', event => {\n          const offsetX = event.changedTouches[0].clientX - this.touchStartX\n          const time = event.timeStamp - this.touchStartTime\n          if (time < 500 && offsetX > 40) {\n            this.prevPage()\n          } else if (time < 500 && offsetX < -40) {\n            this.nextPage()\n          } else {\n            this.toggleMenuVisible()\n          }\n          event.preventDefault()\n          event.stopPropagation()\n        })\n      },\n      initTheme() {\n        let defaultTheme = getTheme(this.fileName)\n        if (!defaultTheme) {\n          defaultTheme = this.themeList[0].name\n          saveTheme(this.fileName, defaultTheme)\n        }\n        return defaultTheme\n      },\n      initFontSize() {\n        let fontSize = getFontSize(this.fileName)\n        if (!fontSize) {\n          fontSize = 16\n          saveFontSize(this.fileName, fontSize)\n        }\n        return fontSize\n      },\n      initFontFamily() {\n        let font = getFontFamily(this.fileName)\n        if (!font) {\n          font = 'Default'\n          saveFontFamily(this.fileName, font)\n        }\n        return font\n      },\n      initRendition() {\n        this.rendition = this.book.renderTo('read', {\n          width: window.innerWidth,\n          height: window.innerHeight,\n          method: 'default'\n        })\n        Promise.all([\n          this.setDefaultTheme(this.initTheme()),\n          this.setDefaultFontSize(this.initFontSize()),\n          this.setDefaultFontFamily(this.initFontFamily())\n        ]).then(() => {\n          this.switchTheme()\n          if (this.$route.query.navigation) {\n            this.display(this.$route.query.navigation)\n          } else {\n            const location = getLocation(this.fileName)\n            if (location) {\n              this.display(location)\n            } else {\n              this.display()\n            }\n          }\n        })\n        this.rendition.hooks.content.register(contents => {\n          Promise.all([\n            contents.addStylesheet(`${process.env.VUE_APP_RES_URL}/fonts/daysOne.css`),\n            contents.addStylesheet(`${process.env.VUE_APP_RES_URL}/fonts/tangerine.css`),\n            contents.addStylesheet(`${process.env.VUE_APP_RES_URL}/fonts/montserrat.css`),\n            contents.addStylesheet(`${process.env.VUE_APP_RES_URL}/fonts/cabin.css`)\n          ]).then(() => {})\n        })\n      },\n      parseBook() {\n        this.book.loaded.metadata.then(metadata => {\n          this.setMetadata(metadata)\n          saveMetadata(this.fileName, metadata)\n        })\n        if (this.isOnline) {\n          this.book.coverUrl().then(url => {\n            this.setCover(url)\n          })\n        } else {\n          this.book.loaded.cover.then(cover => {\n            this.book.archive.createUrl(cover).then(url => {\n              this.setCover(url)\n            })\n          })\n        }\n        this.book.loaded.navigation.then(nav => {\n          console.log(nav)\n          const navItem = (function flatten(arr) {\n            return [].concat(...arr.map(v => [v, ...flatten(v.subitems)]))\n          })(nav.toc)\n\n          function find(item, v = 0) {\n            const parent = navItem.filter(it => it.id === item.parent)[0]\n            return !item.parent ? v : (parent ? find(parent, ++v) : v)\n          }\n\n          navItem.forEach(item => {\n            item.level = find(item)\n            item.total = 0\n            item.pagelist = []\n            if (item.href.match(/^(.*)\\.html$/)) {\n              item.idhref = item.href.match(/^(.*)\\.html$/)[1]\n            } else if (item.href.match(/^(.*)\\.xhtml$/)) {\n              item.idhref = item.href.match(/^(.*)\\.xhtml$/)[1]\n            }\n          })\n          this.setNavigation(navItem)\n        })\n        this.book.ready.then(() => {\n          this.setCurrentBook(this.book)\n          return this.book.locations.generate(750 * (window.innerWidth / 375) * (getFontSize(this.fileName) / 16))\n        }).then(locations => {\n          locations.forEach(location => {\n            const loc = location.match(/\\[(.*)\\]!/)[1]\n            console.log(loc)\n            this.navigation.forEach(item => {\n              if (item.idhref && item.idhref.indexOf(loc) >= 0) {\n                item.pagelist.push(location)\n              }\n            })\n            let currentPage = 1\n            this.navigation.forEach((item, index) => {\n              if (index === 0) {\n                item.page = 1\n              } else {\n                item.page = currentPage\n              }\n              currentPage += item.pagelist.length + 1\n            })\n          })\n          // saveNavigation(this.fileName, this.navigation)\n          this.setPagelist(locations)\n          this.setBookAvailable(true)\n          this.setIsPaginating(false)\n          this.refreshLocation()\n        })\n      },\n      initEpub(target) {\n        this.book = new Epub(target)\n        this.setCurrentBook(this.book)\n        this.setIsPaginating(true)\n        this.setPaginate(this.$t('book.paginating'))\n        this.initRendition()\n        this.initGuest()\n        this.parseBook()\n      }\n    },\n    mounted() {\n      if (this.$route.params.fileName.indexOf('|') > 0) {\n        this.setFileName(\n          this.$route.params.fileName.split('|').join('/'))\n          .then(() => {\n            // 实时下载电子书\n            this.initEpub(`${process.env.VUE_APP_EPUB_URL}/${this.fileName}.epub`)\n            this.isOnline = false\n          })\n      } else {\n        this.setFileName(this.$route.params.fileName)\n          .then(() => {\n            getLocalForage(this.fileName, (err, blob) => {\n              if (!err) {\n                if (blob) {\n                  // 离线阅读模式\n                  this.isOnline = false\n                  this.initEpub(blob)\n                } else {\n                  // 在线阅读模式\n                  this.isOnline = true\n                  const opf = this.$route.query.opf\n                  if (opf) {\n                    this.initEpub(opf)\n                  }\n                }\n              }\n            })\n          })\n      }\n    }\n  }\n</script>\n\n<style lang=\"scss\" rel=\"stylesheet/scss\" scoped>\n  @import \"../../assets/styles/global\";\n\n  .ebook-reader {\n    width: 100%;\n    height: 100%;\n    overflow: hidden;\n    .ebook-reader-mask {\n      position: absolute;\n      z-index: 150;\n      top: 0;\n      left: 0;\n      width: 100%;\n      height: 100%;\n    }\n  }\n</style>\n"],"sourceRoot":"src/components/ebook"}]}